# Prefect Deployment Capability

## Motivation
- Centralise registration of the project flows so `prefect deploy` exposes reproducible entry points for research and operations.
- Provide ready-to-run deployment stubs that analysts can parameterise locally without editing code or YAML.
- Document operational expectations (schedules, parameters, failure surfaces) for the newly registered deployments.

## Inputs / Outputs
- **`ingest-sec-form4`**
  - *Inputs*: ISO dates for `date_from`/`date_to`, optional Supabase credentials (`SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`).
  - *Outputs*: Filing and transaction upserts via `flows/ingest_sec_form4.py:ingest_form4`, returning inserted row counts.
- **`compute-offexchange`**
  - *Inputs*: `trade_date`, optional `symbols`, FINRA HTTP configuration, Supabase credentials.
  - *Outputs*: Upserts (or in-memory lists when `persist=False`) of daily market-structure ratios from `flows/compute_offexchange_features.py`.
- **`compute-intraday`**
  - *Inputs*: Mirrors `compute-offexchange` while a dedicated intraday aggregator is finalised; accepts `trade_date`, optional symbol filters, and persistence toggle.
  - *Outputs*: Delegates to `flows/compute_intraday_features.py:compute_intraday_features`, which currently proxies to the off-exchange computation for smoke-test coverage.
- **`fingerprints`**
  - *Inputs*: Asset symbol, embedder configuration sequence, numeric feature frame or records, optional metadata/timestamps.
  - *Outputs*: Pgvector payloads assembled by `flows/embeddings_and_fingerprints.py:fingerprint_vectorization` (or returned when Supabase is unavailable).
- **`similarity-scans`**
  - *Inputs*: Query JSON path, `k`, optional Supabase filters, output directory, and cross-symbol toggle.
  - *Outputs*: Console rankings plus Markdown/CSV reports emitted by `flows/similarity_scans.py:similarity_scan_flow`.
- **`backtest`**
  - *Inputs*: `InsiderBacktestConfig` dataclass (paths, horizon, validation split, calibration bins, random seed).
  - *Outputs*: `BacktestArtifacts` pointing to metrics JSON and diagnostic plots generated by `flows/backtest.py:insider_prefiling_backtest`.

## Configuration
- Deployments target the `local-agent` work pool; override in `prefect.yaml` when wiring to cloud or remote agents.
- Environment variables supply secrets: Supabase keys for persistence, SEC/FINRA HTTP headers, and any embedder-specific settings.
- Parameter defaults in `prefect.yaml` are neutral (`null` or empty collections) so operators must provide concrete values before execution.
- Cron expressions are documented but commented out by default to keep the registrations manual-first.

## CLI Examples
- List deployments after registration:
  ```bash
  prefect deployment ls
  ```
- Run SEC ingest for a date range:
  ```bash
  prefect deployment run ingest-sec-form4 --params '{"date_from": "2024-12-01", "date_to": "2024-12-31"}'
  ```
- Enrich FINRA off-exchange metrics without persistence:
  ```bash
  prefect deployment run compute-offexchange --params '{"trade_date": "2024-04-01", "persist": false}'
  ```
- Intraday placeholder (reuse off-exchange flow with symbol subset):
  ```bash
  prefect deployment run compute-intraday --params '{"trade_date": "2024-04-01", "symbols": ["AAPL"], "persist": false}'
  ```
- Generate fingerprint vectors using a JSON-serialised configuration:
  ```bash
  prefect deployment run fingerprints --params '{"asset_symbol": "DEMO", "numeric_features": [{"feature_a": 0.1}], "feature_columns": ["feature_a"], "embedder_configs": []}'
  ```
- Run similarity scan and capture reports:
  ```bash
  prefect deployment run similarity-scans --params '{"query_path": "./data/query.json", "k": 10}'
  ```
- Launch the insider pre-filing classifier backtest with a stored config block:
  ```bash
  prefect deployment run backtest --params '{"config": {"windows_path": "data/windows.parquet", "filings_path": "data/form4.parquet", "label_horizon_days": 5, "validation_fraction": 0.2}}'
  ```

## Failure Modes
- Missing secrets raise `MissingSupabaseConfiguration`, leaving persistence as a no-op but allowing dry-run validation.
- Invalid parameter payloads (e.g., absent `date_from`, malformed config dataclasses) cause Prefect parameter coercion or runtime `ValueError`.
- Network errors against SEC/FINRA endpoints propagate as HTTP exceptions after retry exhaustion.
- Fingerprint and backtest deployments surface upstream library import issues (e.g., PCA dependencies, XGBoost/LightGBM availability) in flow logs.
- Similarity scans fail fast on malformed query JSON or missing Supabase vector RPCs.

## Validation Checks
- `prefect deployment ls` should list the six new registrations alongside existing deployments.
- Execute spot runs with mocked credentials (`persist=False`, local CSV/Parquet paths) to confirm flows complete without remote side effects.
- Unit suites already cover the core flows: SEC ingestion parsers, FINRA feature helpers, fingerprint assembly, and similarity reportingâ€”run `python -m pytest tests` selectively for assurance before scheduling.
- Inspect Prefect run logs for emitted counts (filings ingested, symbols processed, vectors persisted) to validate parameter choices prior to automation.
